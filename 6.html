<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¾®ä¿¡æµè§ˆå™¨é€‚é… -->
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>å¹¸è¿å¤§è½¬ç›˜ - å¾®ä¿¡ä¸“å±æŠ½å¥–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¯é€‰ï¼šå¼•å…¥å¾®ä¿¡JS-SDKï¼ˆå¦‚éœ€è·å–openidç­‰ä¿¡æ¯ï¼‰ -->
    <!-- <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script> -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        prize1: '#FF6B6B',   // ä¸€ç­‰å¥–
                        prize2: '#FF9F43',   // äºŒç­‰å¥–
                        prize3: '#FFD166',   // ä¸‰ç­‰å¥–
                        prize4: '#06D6A0',   // å››ç­‰å¥–
                        prize5: '#118AB2',   // äº”ç­‰å¥–
                        prize6: '#073B4C',   // å…­ç­‰å¥–
                        accent: '#FFD166',   // æŠ½å¥–æŒ‰é’®
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif'], // é€‚é…å¾®ä¿¡å­—ä½“
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            /* æ—‹è½¬åŠ¨ç”»ï¼šå¾®ä¿¡æµè§ˆå™¨é€‚é… */
            .wheel-spin {
                transition: transform 5s cubic-bezier(0.19, 1, 0.22, 1) !important;
                transform-origin: center center !important;
            }
            /* ç²¾å‡†æŒ‡é’ˆ */
            .precision-pointer {
                width: 3px;
                height: calc(50% - 45px);
                background: #FF6B6B;
                position: absolute;
                top: 45px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10;
                pointer-events: none;
            }
            .precision-pointer::after {
                content: '';
                position: absolute;
                top: -6px;
                left: 50%;
                transform: translateX(-50%);
                width: 10px;
                height: 10px;
                background: white;
                border: 2px solid #FF6B6B;
                border-radius: 50%;
                box-shadow: 0 0 0 1px #FF6B6B;
            }
            /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
            .btn-disabled {
                background-color: #cccccc !important;
                cursor: not-allowed !important;
                transform: scale(1) !important;
            }
            /* å¾®ä¿¡é€‚é…ï¼šå»é™¤æ»šåŠ¨æ¡ */
            body {
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-6 max-w-lg"> <!-- é€‚é…å¾®ä¿¡çª„å± -->
        <header class="text-center mb-6">
            <h1 class="text-[clamp(1.5rem,5vw,2.5rem)] font-bold text-gray-800 mb-2">å¹¸è¿å¤§è½¬ç›˜</h1>
            <p class="text-gray-600 text-sm">æ¯äººä»…é™æŠ½å¥–1æ¬¡ï¼Œç¥æ‚¨ä¸­å¥–ï¼</p>
        </header>

        <main class="flex flex-col gap-8 items-center">
            <!-- è½¬ç›˜åŒºåŸŸï¼ˆé€‚é…æ‰‹æœºå°ºå¯¸ï¼‰ -->
            <div class="relative w-full max-w-[280px] flex justify-center">
                <div id="wheel-container" class="w-[280px] h-[280px] rounded-full overflow-hidden shadow-xl">
                    <svg id="wheel-svg" class="wheel-spin w-full h-full" viewBox="0 0 280 280"></svg>
                </div>
                <div class="precision-pointer"></div>
                <!-- æŠ½å¥–æŒ‰é’®ï¼ˆé€‚é…æ‰‹æœºç‚¹å‡»ï¼‰ -->
                <button id="spin-btn" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 rounded-full bg-accent text-gray-800 font-bold text-base shadow-lg hover:scale-105 active:scale-95 transition-transform z-20 focus:outline-none">
                    æŠ½å¥–
                </button>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºï¼ˆçªå‡ºæ˜¾ç¤ºï¼‰ -->
            <div id="result-area" class="w-full p-4 bg-white rounded-xl shadow-md min-h-[80px] flex items-center justify-center text-center">
                <span class="text-gray-500 text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æŠ½å¥–</span>
            </div>

            <!-- ç®¡ç†å‘˜å¯éšè—æ¦‚ç‡é¢æ¿ï¼šå¦‚éœ€ç”¨æˆ·ä¸å¯è§ï¼Œåˆ é™¤ä»¥ä¸‹ä»£ç å— -->
            <div class="w-full bg-white rounded-xl shadow-lg p-4">
                <h2 class="text-lg font-bold text-gray-800 mb-4">æ¦‚ç‡è®¾ç½®</h2>
                <div id="prob-controls" class="space-y-4"></div>
                <div class="mt-4 p-2 bg-gray-50 rounded-lg flex justify-between items-center">
                    <span class="text-gray-600 text-sm font-medium">æ€»æ¦‚ç‡ï¼š</span>
                    <span id="total-prob" class="font-bold text-prize1">100%</span>
                </div>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-xs">
            <p>Â© 2025 æŠ½å¥–æ´»åŠ¨ | æ¯äººé™æŠ½1æ¬¡</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================== æ ¸å¿ƒé…ç½® =====================
            // 1. å¥–é¡¹é…ç½®ï¼ˆç®¡ç†å‘˜å¯è°ƒæ•´æ¦‚ç‡ï¼‰
            const PRIZE_CONFIG = [
                { id: 1, name: 'ä¸€ç­‰å¥–', color: '#FF6B6B', probability: 5 },   // 0Â°-60Â°
                { id: 2, name: 'äºŒç­‰å¥–', color: '#FF9F43', probability: 10 },  // 60Â°-120Â°
                { id: 6, name: 'å…­ç­‰å¥–', color: '#073B4C', probability: 25 },  // 120Â°-180Â°
                { id: 5, name: 'äº”ç­‰å¥–', color: '#118AB2', probability: 25 },  // 180Â°-240Â°
                { id: 4, name: 'å››ç­‰å¥–', color: '#06D6A0', probability: 20 },  // 240Â°-300Â°
                { id: 3, name: 'ä¸‰ç­‰å¥–', color: '#FFD166', probability: 15 }   // 300Â°-360Â°
            ];
            const SLICE_ANGLE = 60;       // æ¯ä¸ªæ‰‡åŒº60åº¦
            const WHEEL_RADIUS = 140;     // è½¬ç›˜åŠå¾„ï¼ˆé€‚é…æ‰‹æœºï¼‰
            const SPIN_DURATION = 5000;   // æ—‹è½¬æ—¶é•¿

            // 2. å•æ¬¡æŠ½å¥–é™åˆ¶ï¼ˆå¾®ä¿¡åœºæ™¯ä¼˜åŒ–ï¼‰
            const LOTTERY_ID = 'wechat_lottery_2025'; // ç®¡ç†å‘˜è‡ªå®šä¹‰æ´»åŠ¨ID
            const STORAGE_KEY = `lottery_${LOTTERY_ID}_drawn`; // å­˜å‚¨é”®
            const DEVICE_ID = getDeviceId(); // è·å–è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆé€‚é…å¾®ä¿¡ï¼‰

            // ===================== DOMå…ƒç´  =====================
            const wheelSvg = document.getElementById('wheel-svg');
            const spinBtn = document.getElementById('spin-btn');
            const probControls = document.getElementById('prob-controls');
            const totalProbEl = document.getElementById('total-prob');
            const resultArea = document.getElementById('result-area');

            let isSpinning = false;       // æ—‹è½¬ä¸­
            let currentRotation = 0;      // å½“å‰è§’åº¦
            let hasDrawn = checkHasDrawn(); // æ£€æŸ¥æ˜¯å¦å·²æŠ½å¥–

            // ===================== æ ¸å¿ƒï¼šå¾®ä¿¡åœºæ™¯å•æ¬¡æŠ½å¥–é™åˆ¶ =====================
            /**
             * è·å–è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆé€‚é…å¾®ä¿¡ï¼Œé˜²æ¸…é™¤ç¼“å­˜ï¼‰
             * ä¼˜å…ˆçº§ï¼šå¾®ä¿¡openid > è®¾å¤‡æŒ‡çº¹ > æœ¬åœ°éšæœºID
             */
            function getDeviceId() {
                // 1. å…ˆæŸ¥æœ¬åœ°æ˜¯å¦æœ‰è®¾å¤‡ID
                let deviceId = localStorage.getItem('lottery_device_id');
                if (deviceId) return deviceId;
                
                // 2. ç”Ÿæˆè®¾å¤‡æŒ‡çº¹ï¼ˆåŸºäºæµè§ˆå™¨ä¿¡æ¯ï¼‰
                const fingerprint = [
                    navigator.userAgent,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    navigator.language
                ].join('|');
                
                // 3. ç”Ÿæˆå”¯ä¸€ID
                deviceId = 'dev_' + btoa(fingerprint).substring(0, 20);
                localStorage.setItem('lottery_device_id', deviceId);
                return deviceId;
            }

            /**
             * æ£€æŸ¥æ˜¯å¦å·²æŠ½å¥–ï¼ˆè®¾å¤‡ID+æ´»åŠ¨IDåŒé‡éªŒè¯ï¼‰
             */
            function checkHasDrawn() {
                try {
                    // è¯»å–æŠ½å¥–è®°å½•ï¼šæ ¼å¼ {è®¾å¤‡ID: æŠ½å¥–çŠ¶æ€/ç»“æœ}
                    const drawRecords = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    return drawRecords[DEVICE_ID] === true;
                } catch (e) {
                    return false;
                }
            }

            /**
             * æ ‡è®°æŠ½å¥–å®Œæˆï¼ˆæ°¸ä¹…è®°å½•ï¼‰
             */
            function markDrawCompleted() {
                try {
                    const drawRecords = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    drawRecords[DEVICE_ID] = true; // æ ‡è®°è¯¥è®¾å¤‡å·²æŠ½å¥–
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(drawRecords));
                    hasDrawn = true;
                } catch (e) {
                    // é™çº§ï¼šç›´æ¥å­˜å‚¨
                    localStorage.setItem(`${STORAGE_KEY}_${DEVICE_ID}`, 'true');
                    hasDrawn = true;
                }
            }

            /**
             * ç¦ç”¨æŠ½å¥–æŒ‰é’®ï¼ˆå¾®ä¿¡æ ·å¼é€‚é…ï¼‰
             */
            function disableSpinButton(tip) {
                spinBtn.disabled = true;
                spinBtn.textContent = 'å·²æŠ½å¥–';
                spinBtn.classList.add('btn-disabled', 'opacity-70');
                showResult(tip, 'text-gray-600 text-base');
            }

            // ===================== è½¬ç›˜æ¸²æŸ“ï¼ˆé€‚é…æ‰‹æœºï¼‰ =====================
            function renderWheel() {
                wheelSvg.innerHTML = '';
                
                PRIZE_CONFIG.forEach((prize, index) => {
                    const startAngle = index * SLICE_ANGLE;
                    const endAngle = (index + 1) * SLICE_ANGLE;
                    
                    // è§’åº¦è½¬å¼§åº¦ï¼ˆé€‚é…SVGåæ ‡ç³»ï¼‰
                    const startRad = (startAngle - 90) * Math.PI / 180;
                    const endRad = (endAngle - 90) * Math.PI / 180;
                    
                    // è®¡ç®—æ‰‡å½¢è·¯å¾„
                    const startX = WHEEL_RADIUS + WHEEL_RADIUS * Math.cos(startRad);
                    const startY = WHEEL_RADIUS + WHEEL_RADIUS * Math.sin(startRad);
                    const endX = WHEEL_RADIUS + WHEEL_RADIUS * Math.cos(endRad);
                    const endY = WHEEL_RADIUS + WHEEL_RADIUS * Math.sin(endRad);
                    
                    // åˆ›å»ºæ‰‡å½¢
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', `M ${WHEEL_RADIUS} ${WHEEL_RADIUS} L ${startX} ${startY} A ${WHEEL_RADIUS} ${WHEEL_RADIUS} 0 0 1 ${endX} ${endY} Z`);
                    path.setAttribute('fill', prize.color);
                    wheelSvg.appendChild(path);
                    
                    // ç»˜åˆ¶å¥–é¡¹æ–‡å­—ï¼ˆé€‚é…æ‰‹æœºå°ºå¯¸ï¼‰
                    const centerAngle = startAngle + SLICE_ANGLE / 2;
                    const centerRad = (centerAngle - 90) * Math.PI / 180;
                    const textX = WHEEL_RADIUS + (WHEEL_RADIUS * 0.5) * Math.cos(centerRad);
                    const textY = WHEEL_RADIUS + (WHEEL_RADIUS * 0.5) * Math.sin(centerRad);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', textX);
                    text.setAttribute('y', textY);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('dominant-baseline', 'middle');
                    text.setAttribute('font-size', '14');
                    text.setAttribute('font-weight', 'bold');
                    text.setAttribute('fill', prize.id <= 3 ? '#2A2E3B' : 'white');
                    text.textContent = prize.name;
                    wheelSvg.appendChild(text);
                });

                wheelSvg.style.transform = `rotate(${currentRotation}deg)`;
            }

            // ===================== æ¦‚ç‡é¢æ¿ï¼ˆç®¡ç†å‘˜å¯é…ç½®ï¼‰ =====================
            function initProbControls() {
                probControls.innerHTML = '';
                const sortedPrizes = [...PRIZE_CONFIG].sort((a, b) => a.id - b.id);
                
                sortedPrizes.forEach(prize => {
                    const controlItem = document.createElement('div');
                    controlItem.className = 'space-y-1';
                    
                    const label = document.createElement('label');
                    label.className = 'block text-xs font-medium text-gray-700 flex justify-between';
                    label.innerHTML = `
                        <span>${prize.name}</span>
                        <span id="prob-${prize.id}" class="font-bold text-prize1">${prize.probability}%</span>
                    `;
                    
                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.min = 0;
                    slider.max = 100;
                    slider.value = prize.probability;
                    slider.className = 'w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer';
                    slider.style.background = `linear-gradient(to right, ${prize.color} 0%, ${prize.color} ${prize.probability}%, #e5e7eb ${prize.probability}%, #e5e7eb 100%)`;
                    
                    // å·²æŠ½å¥–åˆ™ç¦ç”¨æ»‘å—
                    slider.addEventListener('input', (e) => {
                        if (isSpinning || hasDrawn) return;
                        const value = parseInt(e.target.value);
                        document.getElementById(`prob-${prize.id}`).textContent = `${value}%`;
                        e.target.style.background = `linear-gradient(to right, ${prize.color} 0%, ${prize.color} ${value}%, #e5e7eb ${value}%, #e5e7eb 100%)`;
                        const targetPrize = PRIZE_CONFIG.find(p => p.id === prize.id);
                        if (targetPrize) targetPrize.probability = value;
                        updateTotalProbability();
                    });
                    
                    controlItem.appendChild(label);
                    controlItem.appendChild(slider);
                    probControls.appendChild(controlItem);
                });

                updateTotalProbability();
            }

            function updateTotalProbability() {
                const total = PRIZE_CONFIG.reduce((sum, prize) => sum + prize.probability, 0);
                totalProbEl.textContent = `${total}%`;
                totalProbEl.className = total === 100 ? 'font-bold text-prize1' : 'font-bold text-yellow-600';
            }

            // ===================== æŠ½å¥–æ ¸å¿ƒé€»è¾‘ =====================
            function selectPrizeByProb() {
                const total = PRIZE_CONFIG.reduce((sum, prize) => sum + prize.probability, 0);
                if (total <= 0) return PRIZE_CONFIG[0];
                
                const random = Math.random() * total;
                let cumulative = 0;
                for (const prize of PRIZE_CONFIG) {
                    cumulative += prize.probability;
                    if (random < cumulative) return prize;
                }
                return PRIZE_CONFIG[PRIZE_CONFIG.length - 1];
            }

            function getPrizeByRotation(rotation) {
                const normRotation = rotation % 360;
                const sectorIndex = Math.floor((360 - normRotation) / SLICE_ANGLE) % PRIZE_CONFIG.length;
                return PRIZE_CONFIG[sectorIndex];
            }

            function spinWheel() {
                // æ ¡éªŒ1ï¼šæ—‹è½¬ä¸­
                if (isSpinning) return;
                // æ ¡éªŒ2ï¼šå·²æŠ½å¥–
                if (hasDrawn) {
                    disableSpinButton('æ‚¨å·²å®ŒæˆæŠ½å¥–ï¼Œæ¯äººä»…é™1æ¬¡ï¼');
                    return;
                }
                // æ ¡éªŒ3ï¼šæ€»æ¦‚ç‡100%
                const totalProb = PRIZE_CONFIG.reduce((sum, prize) => sum + prize.probability, 0);
                if (totalProb !== 100) {
                    showResult('æ¦‚ç‡é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼', 'text-red-500');
                    return;
                }

                // é”å®šçŠ¶æ€
                isSpinning = true;
                spinBtn.disabled = true;
                spinBtn.textContent = 'æŠ½å¥–ä¸­...';
                spinBtn.classList.add('opacity-70');
                showResult('æ­£åœ¨æŠ½å¥–ï¼Œè¯·ç¨å€™...', 'text-gray-500');

                // æ¦‚ç‡é€‰å¥– + è®¡ç®—æ—‹è½¬è§’åº¦
                const targetPrize = selectPrizeByProb();
                const targetIndex = PRIZE_CONFIG.findIndex(p => p.id === targetPrize.id);
                const targetAngle = targetIndex * SLICE_ANGLE + SLICE_ANGLE / 2; // æŒ‡å‘æ‰‡åŒºä¸­å¿ƒ
                const finalRotation = currentRotation + 15 * 360 + (360 - targetAngle);

                // æ‰§è¡Œæ—‹è½¬ï¼ˆå¾®ä¿¡æµè§ˆå™¨é€‚é…ï¼‰
                wheelSvg.classList.remove('wheel-spin');
                wheelSvg.style.transform = `rotate(${currentRotation}deg)`;
                void wheelSvg.offsetWidth; // å¼ºåˆ¶é‡ç»˜
                wheelSvg.classList.add('wheel-spin');
                wheelSvg.style.transform = `rotate(${finalRotation}deg)`;

                // æ—‹è½¬ç»“æŸ
                setTimeout(() => {
                    currentRotation = finalRotation % 360;
                    const actualPrize = getPrizeByRotation(finalRotation);
                    
                    // æ ‡è®°æŠ½å¥–å®Œæˆï¼ˆæ°¸ä¹…é™åˆ¶ï¼‰
                    markDrawCompleted();
                    
                    // ç¦ç”¨æŒ‰é’® + æ˜¾ç¤ºç»“æœ
                    isSpinning = false;
                    disableSpinButton(`ğŸ‰ æ­å–œæ‚¨è·å¾—<span class="text-prize1 font-bold mx-1">${actualPrize.name}</span>ï¼`);
                    
                    // ç»“æœåŠ¨ç”»
                    resultArea.classList.add('animate-pulse');
                    setTimeout(() => resultArea.classList.remove('animate-pulse'), 1000);
                }, SPIN_DURATION);
            }

            function showResult(html, className) {
                resultArea.innerHTML = `<span class="${className}">${html}</span>`;
            }

            // ===================== åˆå§‹åŒ– =====================
            // 1. æ£€æŸ¥æŠ½å¥–çŠ¶æ€ï¼Œå·²æŠ½åˆ™ç¦ç”¨æŒ‰é’®
            if (hasDrawn) {
                disableSpinButton('æ‚¨å·²å®ŒæˆæŠ½å¥–ï¼Œæ¯äººä»…é™1æ¬¡ï¼');
            }
            // 2. æ¸²æŸ“è½¬ç›˜
            renderWheel();
            // 3. åˆå§‹åŒ–æ¦‚ç‡é¢æ¿ï¼ˆç®¡ç†å‘˜å¯è°ƒæ•´ï¼‰
            initProbControls();
            // 4. ç»‘å®šæŠ½å¥–äº‹ä»¶
            spinBtn.addEventListener('click', spinWheel);

            // å¾®ä¿¡é€‚é…ï¼šçª—å£å˜åŒ–é‡ç»˜
            window.addEventListener('resize', () => {
                if (!isSpinning && !hasDrawn) renderWheel();
            });
        });
    </script>
</body>
</html>