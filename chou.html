<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>å¹¸è¿å¤§è½¬ç›˜ - æŠ½å¥–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        prize1: '#FF6B6B', prize2: '#FF9F43', prize3: '#FFD166',
                        prize4: '#06D6A0', prize5: '#118AB2', prize6: '#073B4C',
                        accent: '#FFD166',
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .wheel-spin { transition: transform 5s cubic-bezier(0.19, 1, 0.22, 1) !important; transform-origin: center !important; }
            .precision-pointer { width: 3px; height: calc(50% - 45px); background: #FF6B6B; position: absolute; top: 45px; left: 50%; transform: translateX(-50%); z-index: 10; pointer-events: none; }
            .precision-pointer::after { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 10px; height: 10px; background: white; border: 2px solid #FF6B6B; border-radius: 50%; box-shadow: 0 0 0 1px #FF6B6B; }
            .btn-disabled { background-color: #cccccc !important; cursor: not-allowed !important; transform: scale(1) !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col items-center justify-center p-4">
    <div class="max-w-lg w-full">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">å¹¸è¿å¤§è½¬ç›˜</h1>
            <p class="text-gray-500">æ¯äººä»…é™æŠ½å¥–1æ¬¡</p>
        </header>
        <main class="flex flex-col items-center gap-8">
            <div class="relative w-[280px] h-[280px]">
                <svg id="wheel-svg" class="wheel-spin w-full h-full" viewBox="0 0 280 280"></svg>
                <div class="precision-pointer"></div>
                <button id="spin-btn" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 rounded-full bg-accent text-gray-800 font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform z-20">æŠ½å¥–</button>
            </div>
            <div id="result-area" class="w-full p-4 bg-white rounded-xl shadow-md min-h-[80px] flex items-center justify-center text-center">
                <span class="text-gray-500">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æŠ½å¥–</span>
            </div>
        </main>
    </div>

    <script>
        // é»˜è®¤é…ç½®ï¼Œå¦‚æœconfig.jsonåŠ è½½å¤±è´¥åˆ™ä½¿ç”¨æ­¤é…ç½®
        let PRIZE_CONFIG = [
            { id: 1, name: 'ä¸€ç­‰å¥–', color: '#FF6B6B', probability: 5 },
            { id: 2, name: 'äºŒç­‰å¥–', color: '#FF9F43', probability: 10 },
            { id: 3, name: 'ä¸‰ç­‰å¥–', color: '#FFD166', probability: 15 },
            { id: 4, name: 'å››ç­‰å¥–', color: '#06D6A0', probability: 20 },
            { id: 5, name: 'äº”ç­‰å¥–', color: '#118AB2', probability: 25 },
            { id: 6, name: 'å…­ç­‰å¥–', color: '#073B4C', probability: 25 }
        ];

        // --- ä»è¿™é‡Œå¼€å§‹ï¼Œä»£ç å’Œä¹‹å‰çš„ç±»ä¼¼ï¼Œåªæ˜¯PRIZE_CONFIGæ˜¯åŠ¨æ€çš„ ---
        const SLICE_ANGLE = 60;
        const WHEEL_RADIUS = 140;
        const SPIN_DURATION = 5000;
        const LOTTERY_ID = 'wechat_lottery_2026';
        const STORAGE_KEY = `lottery_${LOTTERY_ID}_drawn`;

        const wheelSvg = document.getElementById('wheel-svg');
        const spinBtn = document.getElementById('spin-btn');
        const resultArea = document.getElementById('result-area');

        let isSpinning = false;
        let currentRotation = 0;
        let hasDrawn = localStorage.getItem(STORAGE_KEY) === 'true';

        function disableSpinButton(tip) {
            spinBtn.disabled = true;
            spinBtn.textContent = 'å·²æŠ½å¥–';
            spinBtn.classList.add('btn-disabled', 'opacity-70');
            showResult(tip, 'text-gray-600 text-base');
        }

        function renderWheel() {
            wheelSvg.innerHTML = '';
            PRIZE_CONFIG.forEach((prize, index) => {
                const startAngle = index * SLICE_ANGLE;
                const endAngle = (startAngle + SLICE_ANGLE);
                const startRad = (startAngle - 90) * Math.PI / 180;
                const endRad = (endAngle - 90) * Math.PI / 180;
                const startX = WHEEL_RADIUS + WHEEL_RADIUS * Math.cos(startRad);
                const startY = WHEEL_RADIUS + WHEEL_RADIUS * Math.sin(startRad);
                const endX = WHEEL_RADIUS + WHEEL_RADIUS * Math.cos(endRad);
                const endY = WHEEL_RADIUS + WHEEL_RADIUS * Math.sin(endRad);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${WHEEL_RADIUS},${WHEEL_RADIUS} L ${startX},${startY} A ${WHEEL_RADIUS},${WHEEL_RADIUS} 0 0 1 ${endX},${endY} Z`);
                path.setAttribute('fill', prize.color);
                wheelSvg.appendChild(path);

                const textAngle = startAngle + SLICE_ANGLE / 2;
                const textRad = (textAngle - 90) * Math.PI / 180;
                const textX = WHEEL_RADIUS + (WHEEL_RADIUS * 0.7) * Math.cos(textRad);
                const textY = WHEEL_RADIUS + (WHEEL_RADIUS * 0.7) * Math.sin(textRad);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', textX);
                text.setAttribute('y', textY);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('alignment-baseline', 'middle');
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', prize.id <= 3 ? '#2A2E3B' : 'white');
                text.textContent = prize.name;
                wheelSvg.appendChild(text);
            });
            wheelSvg.style.transform = `rotate(${currentRotation}deg)`;
        }

        function selectPrizeByProb() {
            const total = PRIZE_CONFIG.reduce((sum, p) => sum + p.probability, 0);
            if (total <= 0) return PRIZE_CONFIG[0];
            const random = Math.random() * total;
            let cumulative = 0;
            for (const prize of PRIZE_CONFIG) {
                cumulative += prize.probability;
                if (random < cumulative) return prize;
            }
            return PRIZE_CONFIG[PRIZE_CONFIG.length - 1];
        }
        
        function getPrizeByRotation(rotation) {
            const normalizedRotation = rotation % 360;
            const sectorAngle = (360 - normalizedRotation) % 360;
            const sectorIndex = Math.floor(sectorAngle / SLICE_ANGLE) % PRIZE_CONFIG.length;
            return PRIZE_CONFIG[sectorIndex];
        }

        function spinWheel() {
            if (isSpinning || hasDrawn) {
                if(hasDrawn) disableSpinButton('æ‚¨å·²å®ŒæˆæŠ½å¥–ï¼Œæ¯äººä»…é™1æ¬¡ï¼');
                return;
            }
            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.textContent = 'æŠ½å¥–ä¸­...';
            showResult('æ­£åœ¨æŠ½å¥–ï¼Œè¯·ç¨å€™...', 'text-gray-500');

            const targetPrize = selectPrizeByProb();
            const targetIndex = PRIZE_CONFIG.findIndex(p => p.id === targetPrize.id);
            const targetAngle = targetIndex * SLICE_ANGLE + SLICE_ANGLE / 2;
            const finalRotation = currentRotation + 15 * 360 + (360 - targetAngle);

            wheelSvg.style.transition = 'none';
            wheelSvg.style.transform = `rotate(${currentRotation}deg)`;
            void wheelSvg.offsetWidth; // å¼ºåˆ¶é‡ç»˜
            wheelSvg.style.transition = 'transform 5s cubic-bezier(0.19, 1, 0.22, 1)';
            wheelSvg.style.transform = `rotate(${finalRotation}deg)`;

            setTimeout(() => {
                currentRotation = finalRotation % 360;
                const actualPrize = getPrizeByRotation(finalRotation);
                hasDrawn = true;
                localStorage.setItem(STORAGE_KEY, 'true');
                isSpinning = false;
                disableSpinButton(`ğŸ‰ æ­å–œæ‚¨è·å¾—<span class="text-prize1 font-bold mx-1">${actualPrize.name}</span>ï¼`);
                resultArea.classList.add('animate-pulse');
                setTimeout(() => resultArea.classList.remove('animate-pulse'), 1000);
            }, SPIN_DURATION);
        }

        function showResult(html, className) {
            resultArea.innerHTML = `<span class="${className}">${html}</span>`;
        }

        // --- åˆå§‹åŒ– ---
        // 1. å°è¯•ä» config.json åŠ è½½é…ç½®
        fetch('config.json')
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                return response.json();
            })
            .then(data => {
                PRIZE_CONFIG = data;
                // 2. é…ç½®åŠ è½½æˆåŠŸåï¼Œæ¸²æŸ“è½¬ç›˜å¹¶ç»‘å®šäº‹ä»¶
                renderWheel();
                spinBtn.addEventListener('click', spinWheel);
                if (hasDrawn) disableSpinButton('æ‚¨å·²å®ŒæˆæŠ½å¥–ï¼Œæ¯äººä»…é™1æ¬¡ï¼');
            })
            .catch(error => {
                console.error('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥:', error);
                showResult('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚', 'text-red-500');
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®è¿›è¡Œåˆå§‹åŒ–
                renderWheel();
                spinBtn.addEventListener('click', spinWheel);
                if (hasDrawn) disableSpinButton('æ‚¨å·²å®ŒæˆæŠ½å¥–ï¼Œæ¯äººä»…é™1æ¬¡ï¼');
            });
    </script>
</body>

</html>
